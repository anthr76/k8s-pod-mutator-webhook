---
  # yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
  name: "Container: Image Build Webhook"
  on:
    workflow_dispatch: {}
    pull_request:
      branches: ["main"]
      types: ["opened", "synchronize", "reopened"]
      paths:
        - .github/workflows/publish-image-webhook.yaml
        - "build/webhook/**/*"
        - "cmd/webhook/**/*"
        - "pkg/**/*"
        - "internal/**/*"
        - "go.**"
        - ".dockerignore"
    push:
      tags:
        - 'k8s-pod-mutator-webhook-v*'
      branches:
        - main
      paths:
        - .github/workflows/publish-image-webhook.yaml
        - "build/webhook/**/*"
        - "cmd/webhook/**/*"
        - "pkg/**/*"
        - "internal/**/*"
        - "go.**"
        - ".dockerignore"

  jobs:
    publish-images:
      name: Publish Image
      permissions:
        contents: write
        packages: write
      runs-on: ubuntu-22.04

      steps:
        - name: Checkout repository
          uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
          with:
            fetch-depth: 0

        - name: Docker meta
          id: meta
          uses: docker/metadata-action@c1e51972afc2121e065aed6d45c65596fe445f3f # v5
          with:
            images: ghcr.io/${{ github.repository }}/webhook
            tags: |
              type=ref,event=pr
              type=schedule
              type=match,pattern=\d.\d.\d
              type=raw,value=latest,enable={{is_default_branch}}

        - name: Set up QEMU
          uses: docker/setup-qemu-action@29109295f81e9208d7d86ff1c6c12d2833863392 # v3.6.0

        - name: Set up Docker Buildx
          uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3.11.1

        - name: Log into registry ghcr.io
          uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
          with:
            registry: ghcr.io
            username: ${{ github.actor }}
            password: ${{ secrets.GITHUB_TOKEN }}

        - name: Build and push Docker image
          id: build-and-push
          uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
          with:
            push: ${{ github.event_name != 'pull_request' }}
            cache-from: type=gha
            cache-to: type=gha,mode=max
            context: ./
            file: ./build/webhook/Dockerfile
            labels: ${{ steps.meta.outputs.labels }}
            platforms: linux/amd64,linux/arm64
            tags: ${{ steps.meta.outputs.tags }}
